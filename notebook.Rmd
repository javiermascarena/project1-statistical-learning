---
title: "R Notebook"
output: html_notebook
---

**SET UP**

-   Importing libraries

-   Importing initial data

```{r}
rm(list = ls())

# Importing libraries
library("dplyr")
library("skimr")
library("ggplot2")
library("ggrepel")
library("stringi")

# Reading initial data
data_stats <- read.csv("2022-2023 Football Player Stats.csv", sep=";")
```

**DATA PREPROCESSING**

Getting an idea of what the dataset looks like.

```{r}
skim(data_stats)
```

Although there are no rows with missing values, if we look at the data closely we discover that there are some players that appear more than once. This might be because maybe they played a couple of games for one team and then got transferred or loaned to another one.

In this case what we will do is combine all the instances of that player in the dataset into a single observation and recalculate all statistics based on the combination of the different rows.

```{r}
# Obtaining the data without repetition
unique_stats <- data_stats %>%
  group_by(Player) %>%
  summarise(
    # Categorical variables
    Nation = first(Nation), 
    Pos = first(Pos),
    Age = first(Age), 
    Born = first(Born),
    # Selecting team and competition where
    # the player has the most starts
    Squad = Squad[which.max(Starts)],  
    Comp = Comp[which.max(Starts)],
    
    
    # Sum the numeric columns since all have 
    # linear statistics of the players
    across(where(is.numeric), sum),
    
    .groups = "drop"
  )

# Changing Neymar's name for easier merging afterwards, 
# since he is an important player that will be necessary for further analysis
unique_stats[1796, "Player"] = "Neymar Jr"
skim(unique_stats)
```

We see that this dataset has many statistics for players, but we could also benefit from other ones that are not there, such as the overall player rating or their price. For this we will merge part of another dataset which bases its rating and some other statistics in the FIFA videogame.

```{r}
# Reading complimentary data
data_fifa <- read.csv("CLEAN_FIFA23_official_data.csv")

skim(data_fifa)
```

Now we will merge this last dataset into the first one.

For this we have first to convert some characters like "Ã©" into standard English alphabet ("e") because of differences between both datasets.

Secondly, since in the FIFA data names come in different formats ("Messi", "L. Messi" or "Lionel Messi") we have to convert it to the format "L. Messi" to then merge it into the first dataset by means of the surname.

```{r}
# Convert 1st dataset to the UTF-8 format for replacing characters
unique_stats$Player <- stri_encode(unique_stats$Player, from = "ISO-8859-1", to = "UTF-8")

# Replacing characters by its closest English alphabet character
unique_stats$Player <- stri_trans_general(unique_stats$Player, "latin-ascii")
data_fifa$Name <- stri_trans_general(data_fifa$Name, "latin-ascii")

# Set a Name column to the format "L. Messi"
data_fifa$StandardizedName <- paste0(substr(data_fifa$Name, 1, 1), ". ", sapply(strsplit(data_fifa$Name, " "), function(x) x[length(x)]))

# Create a new column of the surname
unique_stats$Surname <- sapply(strsplit(unique_stats$Player, " "), function(x) x[length(x)])
data_fifa$Surname <- sapply(strsplit(data_fifa$StandardizedName, " "), function(x) x[length(x)])

# Merge both datasets by Surname
full_data <- full_join(unique_stats, data_fifa, by = "Surname")

# Eliminating NAs and repeated values when merging has not been correct
full_data <- na.omit(full_data)
full_data <- distinct(full_data, Player, .keep_all = TRUE)

head(full_data)
```

We can observe that there are a few missing observations in the original data that have not been merged. Let's have a look at what they look like

```{r}
# Observations not merged
anti_join(unique_stats, full_data, by = "Player")
```

If we take a closer look at each observation we can see that they have not been merged because of one of two options. First, the player was not in the FIFA dataset. Second, the player had unexpected characters such as "?" in his name.

For the first option we cannot do anything, so we will not work with those observations, since also if they do not appear in the video game they probably are not very relevant. For the second option we could manually input the names, but because of the big number of observations with this error, and because there are little to no important players in this group, we decided to omit them.
