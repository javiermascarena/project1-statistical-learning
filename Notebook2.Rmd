---
title: "Notebook"
output: html_document
date: "2024-11-09"
---

**SET UP**

```{r}
rm(list = ls())

# Importing libraries
library("dplyr")
library("skimr")
library("ggplot2")
library("ggrepel")
library("stringi")

```

We have different datasets which contain different statistics from different players which we will need to combine to obtain a richer ando more useful dataset.

```{r}
# Reading the different datasets
defense_stats <- read.csv("Big5-defenseStats22-23.csv", sep = ",")
gca_stats <- read.csv("Big5-gcaStats22-23.csv", sep = ",")
misc_stats <- read.csv("Big5-miscStats22-23.csv", sep = ",")
passing_types <- read.csv("Big5-passing_typesStats22-23.csv", sep = ",")
passing_stats <- read.csv("Big5-passingStats22-23.csv", sep = ",")
possession_stats <- read.csv("Big5-possessionStats22-23.csv", sep = ",")
shooting_stats <- read.csv("Big5-shootingStats22-23.csv", sep = ",")

# Csv statsStats has already included statistics

# Datasets for goalkeepers
keepers_one <- read.csv("Big5-keepersadvStats22-23.csv", sep = ",")
keepers_two <- read.csv("Big5-keepersStats22-23.csv", sep = ",")

# Dataset for all players combined
playingtime <- read.csv("Big5-playingtimeStats22-23.csv", sep = ",")

```

**DATA PREPROCESSIG**

Merging all datasets according to different columns and dealing with missing values and duplicates later, this can be done with the inner join function taken into account that all datasets have the same 8 first columns.

```{r}
# Making a list with the repeated columns
repeated_columns = c("Player", "Nation", "Pos", "Squad", "Comp", "Age", "Born", "X90s")


# Inner joining all datasets based on key columns and a brief look at it
merged_players <- inner_join(defense_stats, gca_stats, by = repeated_columns)%>%
                  inner_join(misc_stats, by = repeated_columns)%>%
                  inner_join(passing_types, by = repeated_columns)%>%
                  inner_join(passing_stats, by = repeated_columns)%>%
                  inner_join(possession_stats, by = repeated_columns)%>%
                  inner_join(shooting_stats, by = repeated_columns)

skim(merged_players)

# Repeating the same process but with goalkeepers

merged_goalkeepers = inner_join(keepers_one,keepers_two, by = repeated_columns)
skim(merged_goalkeepers)
```

We see that Min (Minutes) for goalkeepers is of character type, we should change this to obtain an integer for future, it also has problems for decimals, so we have to change to points instead of commas

```{r}
merged_goalkeepers$Min <- gsub(",", ".", merged_goalkeepers$Min)

merged_goalkeepers$Min <- as.numeric(merged_goalkeepers$Min)
```

We now have the problem that goalkeepers have different stats to players, therefore the number of variables varies and we cannot join them to the same dataset. Instead we need to add the columns which are not in players to goalkeepers with a 0 value for each entry and viceversa.

```{r}
# Obtaining all columns in players and goalkeepers
player_columns <- colnames(merged_players)
gk_columns <- colnames(merged_goalkeepers)

# Finding out the different columns in each of the datasets
missing_columns_players = setdiff(gk_columns, player_columns)
missing_columns_gk = setdiff(player_columns, gk_columns)

# Using a for loop to create the missing columns with a value of 0
for (col in missing_columns_players) {
  merged_players[[col]] <- 0
}

for (col in missing_columns_gk) {
  merged_goalkeepers[[col]] <- 0
}

# Combining both goalkeepers and players
all_players = bind_rows(merged_players,merged_goalkeepers)

# Merging with playing time stats
final_players <- inner_join(all_players, playingtime, by = repeated_columns)
head(final_players)
```

We observe many redundancies in this new dataset, such as that the nations are repeated in both lower and upper case, that some players have more than one position or that the competition also has lower case in front which could be troubling in the future. We will remove the strings with gsub and substr, and maintain only the first position for all players.

```{r}
# Removing lower case in nation
final_players$Nation <- gsub("[a-z]", "", final_players$Nation)
# Saving only the first position
final_players$Pos <- substr(final_players$Pos,1,2)
# Removing lower case before leaguew
final_players$Comp <- substr(final_players$Comp, 4, nchar(final_players$Comp))

# With that solved we will look at the players now to check for NAs and duplicated values
skim(final_players)
```

We see there are many NA values which could be from players who have barely played and therefore many of their data has not been registered. Because of this we will remove all players that have played less very little. For this we have to remove the columns for minutes played and number of starts of goalkeepers, and replace the X90s column in those.

```{r}
# Getting the expected 90s of goalkeepers in the same 
# column as the other players
final_players$X90s <- final_players$X90s + final_players$X.90

# Eliminating goalkeeper columns
final_players <- final_players %>% select(-Starts.x, -Min.x, -X.90)

# Eliminating players that have not played much
final_players <- final_players[final_players$X90s > 2,]

# Number of duplicaated players 
sum(duplicated(final_players$Player))

skim(final_players)
```

Apart from that we also see there are a total of +200 duplicates which could be from players who were transferred or were loaned mid-season. To deal with this, we will keep the entries with the most time played.

```{r}
# Obtaining the data without repeted players
final_players <- final_players %>%
  group_by(Player) %>%
  # Keeping only observations with the most starts
  slice_max(Starts.y, n = 1, with_ties = FALSE) %>%  
  ungroup() %>%
  distinct()

# Check that there are no duplicates now
sum(duplicated(final_players))
```

Now we have to deal with NA values. Since all NA values are in numerical columns, we can replace these NAs by the median of that column.

```{r}
# Replace NA values with the median of each column
final_players <- final_players %>%
  mutate(across(everything(), ~ ifelse(is.na(.), median(., na.rm = TRUE), .)))

# Number of rows with NA values 
nrow(final_players %>% filter(if_any(everything(), is.na)))
```

We see that this dataset has many statistics for players, but we could also benefit from other ones that are not there, such as the overall player rating or their price. For this we will merge part of another dataset which bases its rating and some other statistics in the FIFA videogame.

```{r}
# Reading complimentary data
data_fifa <- read.csv("CLEAN_FIFA23_official_data.csv")

skim(data_fifa)
```

Now that we have cleaned a bit the other dataset we can proceed to merging it with this new and last one.

For this there is a problem, where FIFA players have different name formats ("Messi", "L. Messi" or "Lionel Messi"). To solve this we will first standardized name to the format "L. Messi" and then extract the surnames for both datasets and join by means of the surname.

Also we will replace before all of this all characters from other languages into the closest one in the English alphabet ("è" -\> "e")

```{r}
# Replacing characters by its closest English alphabet character
final_players$Player <- stri_trans_general(final_players$Player, "latin-ascii")
data_fifa$Name <- stri_trans_general(data_fifa$Name, "latin-ascii")

# Handle additional characters manually for specific languages 
final_players$Player <- gsub("ć|č", "c", final_players$Player)
final_players$Player <- gsub("ł", "l", final_players$Player)
final_players$Player <- gsub("ń", "n", final_players$Player)
final_players$Player <- gsub("ă", "a", final_players$Player)
final_players$Player <- gsub("ș|ş", "s", final_players$Player)
final_players$Player <- gsub("ž|ź", "z", final_players$Player)
# Removes other symbols
final_players$Player <- gsub("[^[:alnum:] ]", "", final_players$Player)  

data_fifa$Name <- gsub("ć|č", "c", data_fifa$Name)
data_fifa$Name <- gsub("ł", "l", data_fifa$Name)
data_fifa$Name <- gsub("ń", "n", data_fifa$Name)
data_fifa$Name <- gsub("ă", "a", data_fifa$Name)
data_fifa$Name <- gsub("ș|ş", "s", data_fifa$Name)
data_fifa$Name <- gsub("ž|ź", "z", data_fifa$Name)
data_fifa$Name <- gsub("[^[:alnum:] ]", "", data_fifa$Name)



# Set a Name column to the format "L. Messi"
data_fifa$StandardizedName <- paste0(substr(data_fifa$Name, 1, 1), ". ", sapply(strsplit(data_fifa$Name, " "), function(x) x[length(x)]))

# Create a new column of the surname
final_players$Surname <- sapply(strsplit(final_players$Player, " "), function(x) x[length(x)])
data_fifa$Surname <- sapply(strsplit(data_fifa$StandardizedName, " "), function(x) x[length(x)])

# Merge both datasets by Surname
full_data <- full_join(final_players, data_fifa, by = "Surname")

# Eliminating repeated values when merging has not been correct
full_data <- na.omit(full_data)
full_data <- distinct(full_data, Player, .keep_all = TRUE)
```

We observe that some observations has been lost. If we look closely at the data most of those observations not merged do not appear in the FIFA dataset so, since they are not very relevant we can exclude them confidently.

```{r}
# Observations not merged
not_merged <- anti_join(final_players, full_data, by = "Player")
```

Now that we have the whole data, we will address the huge amount of columns we have. First of all, we will remove columns that reference the same statistics, and also get rid of the useless ones.

```{r}
# Getting rid of useless and repeated columns
useless_repeated_cols = c("StandardizedName", "Year_Joined", "Best.Overall.Rating", "Kit.Number", "Release.Clause...", "Contract.Valid.Until", "Loaned.From", "Joined", "Position", "Real.Face", "Body.Type", "Work.Rate", "Skill.Moves", "Weak.Foot", "International.Reputation", "Special", "Wage...", "Club.Logo", "Club", "Potential", "Flag", "Nationality", "Photo", "Age.y", "Name", "ID", "X", "Surname")

full_data <- full_data %>% select(-all_of(useless_repeated_cols))


```
